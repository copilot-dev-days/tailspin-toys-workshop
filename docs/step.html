<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LSC44NDPLQ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-LSC44NDPLQ');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Copilot CLI Workshop</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="step.css">
    <link rel="stylesheet" href="light-theme.css">
    <script src="theme-toggle.js"></script>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="index.html" class="header-brand">
                <span class="brand-icon">üíª</span>
                <span class="header-title">Copilot CLI Workshop</span>
            </a>
            <div class="header-nav">
                <button class="theme-toggle" onclick="toggleTheme()">‚òÄÔ∏è Light</button>
                <button class="nav-btn" id="prevBtn" onclick="navigate(-1)" disabled>‚Üê Prev</button>
                <button class="nav-btn" id="nextBtn" onclick="navigate(1)">Next ‚Üí</button>
            </div>
        </div>
    </header>

    <div class="layout">
        <aside class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Workshop Steps</div>
                <nav id="stepNav"></nav>
            </div>
        </aside>

        <main class="main">
            <div class="content">
                <div id="markdownContent">
                    <div class="loading">Loading content</div>
                </div>
                <div class="nav-footer" id="navFooter"></div>
            </div>
        </main>
    </div>

    <script>
        const steps = [
            { id: 'readme', file: 'workshop/README.md', title: 'Workshop Overview', number: 'üìö' },
            { id: '00-prereqs', file: 'workshop/00-prereqs.md', title: 'Prerequisites', number: '00' },
            { id: '01-custom-instructions', file: 'workshop/01-custom-instructions.md', title: 'Custom Instructions', number: '01' },
            { id: '02-install-copilot-cli', file: 'workshop/02-install-copilot-cli.md', title: 'Install Copilot CLI', number: '02' },
            { id: '03-mcp', file: 'workshop/03-mcp.md', title: 'MCP Servers', number: '03' },
            { id: '04-generating-code', file: 'workshop/04-generating-code.md', title: 'Generating Code', number: '04' },
            { id: '05-agent-skills', file: 'workshop/05-agent-skills.md', title: 'Agent Skills', number: '05' },
            { id: '06-custom-agents', file: 'workshop/06-custom-agents.md', title: 'Custom Agents', number: '06' },
            { id: '07-slash-commands', file: 'workshop/07-slash-commands.md', title: 'Slash Commands', number: '07' },
            { id: '08-review', file: 'workshop/08-review.md', title: 'Review & Next Steps', number: '08' },
        ];

        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.protocol === 'file:';
        const GITHUB_RAW_BASE = isLocal ? '../' : 'https://raw.githubusercontent.com/copilot-dev-days/tailspin-toys-workshop/main/';

        let currentIndex = 0;

        function getStepFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('step') || 'readme';
        }

        function buildSidebar() {
            const nav = document.getElementById('stepNav');
            nav.innerHTML = steps.map((step, i) => `
                <a href="?step=${step.id}" class="step-link ${i === currentIndex ? 'active' : ''}" data-index="${i}">
                    <span class="step-number">${step.number}</span>
                    <span>${step.title}</span>
                </a>
            `).join('');
        }

        function updateNavButtons() {
            document.getElementById('prevBtn').disabled = currentIndex === 0;
            document.getElementById('nextBtn').disabled = currentIndex === steps.length - 1;
        }

        function buildFooterNav() {
            const footer = document.getElementById('navFooter');
            const prev = currentIndex > 0 ? steps[currentIndex - 1] : null;
            const next = currentIndex < steps.length - 1 ? steps[currentIndex + 1] : null;
            footer.innerHTML = `
                <a href="${prev ? '?step=' + prev.id : '#'}" class="nav-footer-btn ${!prev ? 'disabled' : ''}">‚Üê ${prev ? prev.title : 'Previous'}</a>
                <a href="${next ? '?step=' + next.id : '#'}" class="nav-footer-btn ${!next ? 'disabled' : ''}">${next ? next.title : 'Next'} ‚Üí</a>
            `;
        }

        function navigate(direction) {
            const newIndex = currentIndex + direction;
            if (newIndex >= 0 && newIndex < steps.length) {
                window.location.href = `?step=${steps[newIndex].id}`;
            }
        }

        function processMarkdown(md) {
            // Handle GitHub alerts: [!NOTE], [!TIP], [!IMPORTANT], [!WARNING], [!CAUTION]
            md = md.replace(/> \[!(NOTE|TIP|IMPORTANT|WARNING|CAUTION)\]\s*\n((?:> .*(?:\n|$))*)/gi, function(match, type, content) {
                const cleanContent = content.replace(/^> ?/gm, '').trim();
                const icons = { NOTE: '‚ÑπÔ∏è', TIP: 'üí°', IMPORTANT: '‚ùó', WARNING: '‚ö†Ô∏è', CAUTION: 'üî¥' };
                const colors = { NOTE: 'var(--neon-cyan)', TIP: 'var(--success-green)', IMPORTANT: 'var(--neon-purple)', WARNING: 'var(--warning-yellow)', CAUTION: '#ff6b6b' };
                const icon = icons[type.toUpperCase()] || '‚ÑπÔ∏è';
                const color = colors[type.toUpperCase()] || 'var(--neon-cyan)';
                return `<blockquote style="border-left-color: ${color};"><p style="color: ${color};">${icon} ${type.toUpperCase()}</p><p>${cleanContent}</p></blockquote>\n`;
            });

            // Convert internal .md links to step.html links
            md = md.replace(/\[([^\]]+)\]\((?:\.\/)?workshop\/(\d+)-([^)]+)\.md\)/g, function(match, text, num, slug) {
                const stepId = num.replace(/^0+/, '0') + '-' + slug;
                const found = steps.find(s => s.id === stepId || s.file === `workshop/${num}-${slug}.md`);
                if (found) {
                    return `[${text}](step.html?step=${found.id})`;
                }
                return match;
            });

            return md;
        }

        async function loadStep(stepId) {
            const step = steps.find(s => s.id === stepId);
            if (!step) {
                document.getElementById('markdownContent').innerHTML = '<p>Step not found.</p>';
                return;
            }
            currentIndex = steps.indexOf(step);
            buildSidebar();
            updateNavButtons();
            buildFooterNav();
            document.title = `${step.title} - GitHub Copilot CLI Workshop`;

            const contentEl = document.getElementById('markdownContent');
            contentEl.innerHTML = '<div class="loading">Loading content</div>';

            try {
                const url = GITHUB_RAW_BASE + step.file;
                const res = await fetch(url);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                let md = await res.text();
                md = processMarkdown(md);
                // Fix relative image paths to resolve against the markdown file's directory
                const stepDir = step.file.substring(0, step.file.lastIndexOf('/') + 1);
                md = md.replace(/!\[([^\]]*)\]\((?!https?:\/\/|\/\/)([^)]+)\)/g, (match, alt, path) => {
                    const cleanPath = path.replace(/^\.\//, '');
                    return `![${alt}](${GITHUB_RAW_BASE}${stepDir}${cleanPath})`;
                });
                contentEl.innerHTML = `<div class="markdown">${marked.parse(md)}</div>`;

                // Fire confetti on last step
                if (currentIndex === steps.length - 1 && typeof confetti === 'function') {
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                }
            } catch (err) {
                contentEl.innerHTML = `
                    <div class="markdown">
                        <h1>${step.title}</h1>
                        <p>Could not load content. Please check the <a href="https://github.com/copilot-dev-days/tailspin-toys-workshop" target="_blank">GitHub repository</a> directly.</p>
                        <p style="color: var(--text-secondary); font-size: 0.875rem;">Error: ${err.message}</p>
                    </div>`;
            }
        }

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') navigate(-1);
            if (e.key === 'ArrowRight') navigate(1);
        });

        // Initialize
        loadStep(getStepFromURL());
    </script>
</body>
</html>
